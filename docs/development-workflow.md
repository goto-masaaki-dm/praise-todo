# 開発フロー

## 概要

本ドキュメントでは、Praise Todoプロジェクトの開発フローと開発プロセスを説明します。

## 開発フローの全体像

本プロジェクトは、AIアシスタントと協働しながら反復的に開発を進めます。以下の10ステップを繰り返し実行します。

### 1. AIと仕様を固める

実装を開始する前に、AIアシスタントと仕様を確認・合意します。

- `docs/specification.md`を参照して要件を確認
- `docs/features.md`で機能の詳細を確認
- 不明点があれば明確にする
- 実装方針を決定する

### 2. 重要な機能だけテストケースを決める

すべての機能にテストを書くのではなく、重要な機能のみテストケースを事前に決めます。

- ビジネスロジックの核心部分
- データの整合性が重要な部分
- セキュリティに関わる部分

**注意**: 頻繁に修正する部分のテストは後回しにします。開発速度を優先し、安定してからテストを追加します。

### 3. AIに実装させる

AIアシスタントに実装を依頼します。

- クリーンアーキテクチャの原則に従う
- `docs/architecture.md`の設計に従う
- 既存のコードスタイルに合わせる

### 4. AIにテストコードも書かせる

実装と同時に、AIアシスタントにテストコードも作成してもらいます。

- 単体テスト（Unit Test）
- 統合テスト（Integration Test）
- E2Eテスト（必要に応じて）

### 5. テストを実行

作成したテストコードを実行して、エラーがないか確認します。

```bash
pnpm test
```

### 6. エラーが出たら修正

テストでエラーが出た場合、または実装に問題がある場合は修正します。

- エラーメッセージを確認
- 原因を特定
- 修正を実施
- 再度テストを実行

### 7. 画面の動作を確認

実装が完了したら、実際に画面で動作を確認します。

- 開発サーバーを起動
- ブラウザで動作確認
- ユーザー体験を確認

### 8. 思ったのと違ったら仕様書を修正

画面の動作を確認して、想定と異なる場合は仕様書を修正します。

- `docs/specification.md`を更新
- `docs/features.md`を更新（必要に応じて）
- 変更内容を明確に記録

### 9. テストも修正

仕様書の変更に合わせて、テストコードも修正します。

- テストケースを更新
- 新しい要件に対応したテストを追加
- 不要になったテストを削除

### 10. 3に戻って繰り返し

修正が完了したら、ステップ3に戻って実装を繰り返します。

この反復的な開発サイクルにより、段階的に機能を完成させていきます。

## テスト戦略

### テストの優先順位

1. **最優先**: ビジネスロジックの核心部分
   - Domain層のエンティティとビジネスルール
   - Application層のユースケース

2. **高優先度**: データの整合性が重要な部分
   - リポジトリの実装
   - データベース操作

3. **中優先度**: UIの重要な機能
   - フォームのバリデーション
   - エラーハンドリング

4. **低優先度**: 頻繁に修正する部分
   - UIコンポーネントの細かい調整
   - スタイリングの変更

### テストの後回し

以下のような部分は、開発速度を優先してテストを後回しにします：

- UIコンポーネントの見た目の調整
- スタイリングの変更
- 実験的な機能
- 頻繁に仕様が変わる機能

安定してからテストを追加することで、開発効率を向上させます。

## プルリクエストプロセス

### コードレビュー

プルリクエスト時には、必ず人の目でコードを確認します。

- コードの品質を確認
- アーキテクチャの原則に従っているか確認
- セキュリティ上の問題がないか確認
- パフォーマンスの問題がないか確認

### セキュリティチェックリスト

コードレビュー時には、以下のセキュリティ項目を確認します：

#### 認証・認可
- [ ] 認証が必要なエンドポイントで認証チェックが実装されているか
- [ ] ユーザーが自分のデータのみアクセスできるようになっているか
- [ ] Row Level Security（RLS）ポリシーが適切に設定されているか
- [ ] 権限チェックが実装されているか

#### 入力検証
- [ ] すべてのユーザー入力が検証されているか
- [ ] Domain層でのバリデーションが実装されているか
- [ ] 文字数制限、型チェックが実ックされているか
- [ ] SQLインジェクション対策が取られているか（Prisma使用）

#### XSS対策
- [ ] ユーザー入力が適切にエスケープされているか
- [ ] `dangerouslySetInnerHTML`が使用されていないか（使用する場合は厳重にサニタイズ）
- [ ] Content Security Policy（CSP）が設定されているか

#### データ保護
- [ ] 機密情報が環境変数に保存されているか
- [ ] 環境変数が`.gitignore`に追加されているか
- [ ] ログに機密情報が出力されていないか
- [ ] エラーメッセージに機密情報が含まれていないか

#### セキュリティヘッダー
- [ ] 適切なセキュリティヘッダーが設定されているか
- [ ] HTTPSが強制されているか

### 仕様書の更新

実装中に仕様が変更された場合は、必ず`docs/specification.md`を更新します。

- 変更内容を明確に記録
- 変更理由を説明
- 影響範囲を記載

## 反復的な開発サイクル

本プロジェクトは、小さなサイクルを繰り返すことで、段階的に機能を完成させます。

```
仕様確認 → テストケース決定 → 実装 → テスト作成 → テスト実行
    ↑                                                      ↓
仕様修正 ← 動作確認 ← エラー修正 ← テスト修正 ← エラー発生
```

このサイクルを繰り返すことで：

- 早期に問題を発見できる
- 仕様と実装のズレを最小限に抑えられる
- 段階的に品質を向上させられる
- 開発速度を維持できる

## 開発環境

### 必要なツール

- Node.js（推奨バージョン: 20以上）
- pnpm
- Git

### 開発サーバーの起動

```bash
pnpm install
pnpm dev
```

### テストの実行

```bash
pnpm test
```

### ビルド

```bash
pnpm build
```

## ドキュメント参照

開発時には以下のドキュメントを参照してください：

- `docs/specification.md` - プロジェクトの仕様書
- `docs/features.md` - 機能の詳細仕様
- `docs/architecture.md` - アーキテクチャ設計書
- `docs/database-schema.md` - データベーススキーマ

## セキュリティ対策

### セキュリティの重要性

本プロジェクトでは、ユーザーのデータを保護し、セキュリティリスクを最小限に抑えることが重要です。

### 実装時のセキュリティ対策

#### 1. 認証・認可の実装

- **Supabase認証**: 必要に応じてSupabase認証を実装
- **Row Level Security（RLS）**: データベースレベルでユーザーごとのデータ分離を実装
- **権限チェック**: アプリケーションレベルでも権限チェックを実装

詳細は`docs/database-schema.md`の「セキュリティ考慮事項」セクションを参照してください。

#### 2. 入力検証の実装

- **Domain層**: ビジネスルールに基づくバリデーション
- **Application層**: DTOレベルでの追加検証
- **Presentation層**: フォーム入力時の即座のバリデーション

すべてのユーザー入力は、以下の観点で検証します：

- 文字数制限
- 型チェック（文字列、数値、日付など）
- 必須項目チェック
- フォーマットチェック（メールアドレス、URLなど）
- ビジネスルールチェック（例：優先度の値が有効か）

#### 3. SQLインジェクション対策

- Prismaを使用することで、自動的にSQLインジェクション対策が実装されます
- 生のSQLクエリは使用せず、Prismaクエリビルダーを使用します
- パラメータ化クエリを使用します

#### 4. XSS（Cross-Site Scripting）対策

- Reactのデフォルトのエスケープ機能を活用します
- `dangerouslySetInnerHTML`は使用しません（やむを得ない場合は厳重にサニタイズ）
- ユーザー入力データをそのままHTMLに出力しません
- Content Security Policy（CSP）を設定します

#### 5. CSRF（Cross-Site Request Forgery）対策

- Next.jsのCSRF保護機能を活用します
- SameSite Cookie属性を設定します
- 重要な操作にはトークンを使用します

#### 6. データ保護

- **環境変数**: 機密情報（パスワード、トークン、APIキーなど）は環境変数に保存
- **`.gitignore`**: 環境変数ファイル（`.env.local`など）は`.gitignore`に追加
- **ログ**: ログに機密情報を出力しない
- **エラーメッセージ**: エラーメッセージに機密情報を含めない

#### 7. セキュリティヘッダー

Next.jsの設定で、以下のセキュリティヘッダーを設定します：

- `X-Frame-Options`: クリックジャッキング対策
- `X-Content-Type-Options`: MIMEタイプスニッフィング対策
- `X-XSS-Protection`: XSS対策
- `Strict-Transport-Security`: HTTPS強制
- `Content-Security-Policy`: XSSやインジェクション攻撃対策

### セキュリティレビュープロセス

プルリクエスト時には、以下のセキュリティチェックリストを使用して確認します：

1. **認証・認可**: 認証が必要なエンドポイントで認証チェックが実装されているか
2. **入力検証**: すべてのユーザー入力が検証されているか
3. **XSS対策**: ユーザー入力が適切にエスケープされているか
4. **データ保護**: 機密情報が適切に保護されているか
5. **セキュリティヘッダー**: 適切なセキュリティヘッダーが設定されているか

詳細は「プルリクエストプロセス」セクションの「セキュリティチェックリスト」を参照してください。

### セキュリティ関連ドキュメント

以下のドキュメントも参照してください：

- `docs/specification.md` - セキュリティ要件
- `docs/architecture.md` - セキュリティ設計
- `docs/database-schema.md` - Row Level Security（RLS）ポリシー

## まとめ

本プロジェクトは、AIアシスタントと協働しながら、反復的な開発サイクルで進めます。重要な機能にはテストを書き、頻繁に修正する部分は後回しにすることで、開発速度と品質のバランスを取ります。プルリクエスト時には必ず人の目でコードを確認し、セキュリティチェックリストを使用してセキュリティ上の問題がないか確認します。仕様の変更があればドキュメントを更新します。

